name: Redis ARM64 Sync to Release
on: 
  workflow_dispatch: # 核心：仅开启手动触发
    inputs:
      tag_name:
        description: 'Release Tag Name'
        required: true
        default: 'v8.6.0-manual'

jobs:
  redis-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须赋予写入 Release 的权限
    steps:
      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Pull and Save Redis ARM64
        run: |
          # 抓取 Redis 8.6.0-alpine 的 arm64 版本
          skopeo copy \
            --override-os linux \
            --override-arch arm64 \
            docker://docker.io/library/redis:8.6.0-alpine \
            docker-archive:redis-8.6.0-arm64.tar:redis:8.6.0-alpine
            
          # 2. 手动进行极高比例压缩
          gzip -9 redis-8.6.0-arm64.tar
          # 此时会生成一个 redis-8.6.0-arm64.tar.gz 文件，体积会降到 33MB 左右

      - name: Create Release and Upload Tar
        uses: softprops/action-gh-release@v2
        with:
          tag_name: redis-8.6.0-${{ github.run_number }}
          name: Redis 8.6.0 ARM64 Release
          body: |
            Redis 8.6.0-alpine for ARM64 (Kylin V10 SP3 compatible)
            Architecture: arm64
            Format: Docker Archive (.tar)
          files: redis-8.6.0-arm64.tar.gz  # 上传压缩后的文件
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
